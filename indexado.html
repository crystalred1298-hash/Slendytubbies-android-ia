<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Slendytubbies: Victoria Update</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; touch-action: none; font-family: 'Segoe UI', Arial, sans-serif; }
        
        #contador {
            position: absolute; top: 20px; right: 20px;
            background: rgba(255, 0, 255, 0.3); color: #fff;
            padding: 10px 20px; border-radius: 5px; border: 2px solid #ff66ff;
            font-size: 22px; font-weight: bold; z-index: 500;
        }

        #menu, #death, #win {
            position: absolute; width: 100%; height: 100%; z-index: 1000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.85); color: white; text-align: center;
        }
        #death, #win { display: none; }
        #death h1 { color: red; font-size: 3rem; }
        #win h1 { color: #00ff00; font-size: 3rem; text-shadow: 0 0 15px #0f0; }
        
        .btn-container { display: flex; gap: 20px; margin-top: 20px; }
        button { padding: 15px 30px; font-size: 18px; background: #ff00ff; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-exit { background: #444; }

        .joystick-base {
            position: absolute; width: 110px; height: 110px; background: rgba(255,255,255,0.15);
            border: 2px solid rgba(255,255,255,0.4); border-radius: 50%; z-index: 100;
        }
        #joy-move { bottom: 30px; left: 30px; }
        #joy-look { bottom: 30px; right: 30px; }
        .knob {
            position: absolute; width: 44px; height: 44px; background: #fff;
            border-radius: 50%; top: 33px; left: 33px; opacity: 0.7;
        }
    </style>
</head>
<body>

    <div id="contador">Papillas: 0 / 10</div>

    <div id="menu">
        <h1 style="color:#ff66ff">SLENDYTUBBIES 1 AI</h1>
        <p>RECOGE LAS 10 PAPILLAS PARA GANAR</p>
        <button onclick="startGame()">JUGAR</button>
    </div>

    <div id="death">
        <h1>TINKY WINKY TE ATRAPÓ</h1>
        <button onclick="location.reload()">REINTENTAR</button>
    </div>

    <div id="win">
        <h1>¡VICTORIA!</h1>
        <p>Has recogido todas las papillas y sobrevivido.</p>
        <div class="btn-container">
            <button onclick="location.reload()">VOLVER AL MENÚ</button>
            <button class="btn-exit" onclick="window.close(); alert('Para salir, cierra la pestaña del navegador')">SALIR DEL JUEGO</button>
        </div>
    </div>

    <div id="joy-move" class="joystick-base"><div id="move-knob" class="knob"></div></div>
    <div id="joy-look" class="joystick-base"><div id="look-knob" class="knob"></div></div>

    <script src="https://unpkg.com/three@0.150.1/build/three.min.js"></script>

    <script>
        let scene, camera, renderer, player, tinky;
        let papillas = [], gameActive = false, score = 0;
        let moveInput = {x: 0, y: 0}, lookInput = {x: 0, y: 0};
        
        // SENSIBILIDAD AJUSTADA (Más baja para mayor control)
        const SENSITIVITY = 0.04; 

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x050510);
            scene.fog = new THREE.Fog(0x050510, 5, 45);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            const light = new THREE.HemisphereLight(0xffffff, 0x444444, 1.2);
            scene.add(light);

            player = new THREE.Group();
            player.position.set(0, 1.6, 25);
            player.add(camera);
            scene.add(player);

            const ground = new THREE.Mesh(new THREE.PlaneGeometry(150, 150), new THREE.MeshStandardMaterial({color: 0x1a2e1a}));
            ground.rotation.x = -Math.PI/2;
            scene.add(ground);

            // MAPA: Árboles, Lago, Casa
            for(let i=0; i<40; i++) createTree(Math.random()*120-60, Math.random()*120-60);
            
            const lake = new THREE.Mesh(new THREE.CircleGeometry(12, 32), new THREE.MeshStandardMaterial({color: 0x001133}));
            lake.rotation.x = -Math.PI/2; lake.position.set(25, 0.02, -25);
            scene.add(lake);
            
            const laalaa = new THREE.Mesh(new THREE.CapsuleGeometry(0.4, 1.2), new THREE.MeshStandardMaterial({color: "yellow"}));
            laalaa.position.set(20, 0.4, -18); laalaa.rotation.z = Math.PI/2;
            scene.add(laalaa);

            createHouse(-25, 0, -20);

            const po = new THREE.Mesh(new THREE.CapsuleGeometry(0.4, 1.2), new THREE.MeshStandardMaterial({color: "red"}));
            po.position.set(-15, 4, 10);
            scene.add(po);

            // PAPILLAS
            for(let i=0; i<10; i++) {
                const pGroup = new THREE.Group();
                const bowl = new THREE.Mesh(new THREE.CylinderGeometry(0.4, 0.3, 0.2), new THREE.MeshStandardMaterial({color: 0x777}));
                const cream = new THREE.Mesh(new THREE.SphereGeometry(0.35, 8, 8, 0, Math.PI*2, 0, Math.PI/2), new THREE.MeshStandardMaterial({color: 0xff66ff}));
                cream.position.y = 0.1; pGroup.add(bowl, cream);
                pGroup.position.set(Math.random()*100-50, 0.15, Math.random()*100-50);
                scene.add(pGroup); papillas.push(pGroup);
            }

            tinky = new THREE.Mesh(new THREE.CapsuleGeometry(0.6, 1.8), new THREE.MeshStandardMaterial({color: 0x4B0082}));
            tinky.position.set(0, 1.3, -30);
            scene.add(tinky);

            setupControls();
            animate();
        }

        function createTree(x, z) {
            const trunk = new THREE.Mesh(new THREE.CylinderGeometry(0.3, 0.4, 4), new THREE.MeshStandardMaterial({color: 0x3d2817}));
            const leaves = new THREE.Mesh(new THREE.ConeGeometry(2, 6, 8), new THREE.MeshStandardMaterial({color: 0x0a2b0a}));
            leaves.position.y = 4;
            const tree = new THREE.Group();
            tree.add(trunk, leaves); tree.position.set(x, 2, z);
            scene.add(tree);
        }

        function createHouse(x, y, z) {
            const dome = new THREE.Mesh(new THREE.SphereGeometry(7, 32, 16, 0, Math.PI*2, 0, Math.PI/2), new THREE.MeshStandardMaterial({color: 0x228B22}));
            dome.position.set(x, y, z); scene.add(dome);
            const dipsy = new THREE.Mesh(new THREE.CapsuleGeometry(0.4, 1.2), new THREE.MeshStandardMaterial({color: "green"}));
            dipsy.position.set(x-2, 0.6, z+2); scene.add(dipsy);
            const noonoo = new THREE.Mesh(new THREE.BoxGeometry(1, 0.8, 1.5), new THREE.MeshStandardMaterial({color: "blue"}));
            noonoo.position.set(x+2, 0.4, z+1); scene.add(noonoo);
        }

        function setupControls() {
            const moveJoy = document.getElementById('joy-move');
            const lookJoy = document.getElementById('joy-look');
            const moveKnob = document.getElementById('move-knob');
            const lookKnob = document.getElementById('look-knob');

            const handleJoy = (e, isMove) => {
                e.preventDefault();
                const t = e.targetTouches[0];
                const rect = (isMove ? moveJoy : lookJoy).getBoundingClientRect();
                const dx = t.clientX - (rect.left + 55), dy = t.clientY - (rect.top + 55);
                const dist = Math.min(Math.sqrt(dx*dx + dy*dy), 45);
                const angle = Math.atan2(dy, dx);
                const kx = Math.cos(angle) * dist, ky = Math.sin(angle) * dist;
                (isMove ? moveKnob : lookKnob).style.transform = `translate(${kx}px, ${ky}px)`;
                if(isMove) { moveInput.x = kx/45; moveInput.y = ky/45; }
                else { lookInput.x = kx/45; lookInput.y = ky/45; }
            };

            moveJoy.addEventListener('touchmove', e => handleJoy(e, true));
            lookJoy.addEventListener('touchmove', e => handleJoy(e, false));
            const reset = (isMove) => {
                if(isMove) { moveInput = {x:0, y:0}; moveKnob.style.transform = ''; }
                else { lookInput = {x:0, y:0}; lookKnob.style.transform = ''; }
            };
            moveJoy.addEventListener('touchend', () => reset(true));
            lookJoy.addEventListener('touchend', () => reset(false));
        }

        function startGame() { document.getElementById('menu').style.display = 'none'; gameActive = true; }

        function animate() {
            requestAnimationFrame(animate);
            if(!gameActive) return;

            const forward = new THREE.Vector3(0, 0, -1).applyQuaternion(player.quaternion);
            const side = new THREE.Vector3(1, 0, 0).applyQuaternion(player.quaternion);
            player.position.addScaledVector(forward, -moveInput.y * 0.18);
            player.position.addScaledVector(side, moveInput.x * 0.18);

            // ROTACIÓN CON SENSIBILIDAD AJUSTADA
            player.rotation.y -= lookInput.x * SENSITIVITY;
            camera.rotation.x -= lookInput.y * SENSITIVITY;
            camera.rotation.x = Math.max(-1.4, Math.min(1.4, camera.rotation.x));

            tinky.lookAt(player.position.x, 1.3, player.position.z);
            tinky.translateZ(0.06);

            // AGARRAR PAPILLAS Y LÓGICA DE VICTORIA
            papillas.forEach((p, i) => {
                if(p.position.distanceTo(player.position) < 2.2) {
                    scene.remove(p); papillas.splice(i, 1);
                    score++; document.getElementById('contador').innerText = `Papillas: ${score} / 10`;
                    
                    if(score === 10) {
                        gameActive = false;
                        document.getElementById('win').style.display = 'flex';
                    }
                }
            });

            if(tinky.position.distanceTo(player.position) < 1.6) {
                gameActive = false; document.getElementById('death').style.display = 'flex';
            }

            renderer.render(scene, camera);
        }

        window.onload = init;
    </script>
</body>
</html>
