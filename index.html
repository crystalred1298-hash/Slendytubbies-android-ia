<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Slendytubbies: Alternate Endings</title>
    
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; overflow: hidden; background: #000; touch-action: none; font-family: 'Segoe UI', sans-serif; width: 100vw; height: 100vh; }

        #ui-container { position: absolute; top: env(safe-area-inset-top, 20px); width: 100%; display: flex; justify-content: space-between; padding: 0 20px; z-index: 500; align-items: center; }
        #contador { background: rgba(0, 0, 0, 0.7); color: #fff; padding: 10px 20px; border-radius: 50px; border: 2px solid #ff66ff; font-weight: bold; }
        
        .ui-btn { background: rgba(255, 255, 255, 0.2); color: white; border: 1px solid white; padding: 12px; border-radius: 12px; font-size: 14px; font-weight: bold; }

        #jump-btn { position: absolute; right: 30px; bottom: 210px; width: 70px; height: 70px; background: rgba(255, 255, 255, 0.3); border: 3px solid #ff66ff; border-radius: 50%; color: white; font-weight: bold; z-index: 600; display: flex; align-items: center; justify-content: center; touch-action: none; }

        #estatica { position: absolute; width: 100%; height: 100%; top: 0; left: 0; background: url('https://media.giphy.com/media/oEI9uWUic8vle/giphy.gif'); opacity: 0; pointer-events: none; z-index: 400; mix-blend-mode: screen; }

        .joystick-base { position: absolute; width: 110px; height: 110px; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; z-index: 100; bottom: 80px; }
        #joy-move { left: 30px; }
        #joy-look { right: 30px; }
        .knob { position: absolute; width: 45px; height: 45px; background: #ff66ff; border-radius: 50%; top: 32.5px; left: 32.5px; }

        #menu, #modos, #death, #win { position: absolute; width: 100%; height: 100%; z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #000; color: white; text-align: center; }
        #modos, #death, #win { display: none; }
        
        .glitch { font-size: 2.5rem; color: #ff00ff; text-shadow: 2px 2px #ff0000; font-weight: bold; margin-bottom: 10px; }
        .play-btn { padding: 15px 40px; background: #ff00ff; color: white; border: none; border-radius: 8px; font-weight: bold; margin: 10px; width: 220px; text-transform: uppercase; }
        .mode-day { background: #4dabff; border-bottom: 4px solid #2d6699; }
        .mode-sunset { background: #ff8c4d; border-bottom: 4px solid #b35900; }
        .mode-night { background: #2a0050; border-bottom: 4px solid #150029; }
    </style>
</head>
<body>

    <div id="estatica"></div>
    <div id="ui-container">
        <button class="ui-btn" onclick="toggleCamera()">CÁMARA</button>
        <div id="contador">PAPILLAS: 0 / 10</div>
    </div>

    <div id="jump-btn" onpointerdown="jump()">SALTAR</div>

    <div id="menu">
        <div class="glitch">SLENDY IA: FINALES</div>
        <button class="play-btn" onclick="showModes()">JUGAR</button>
    </div>

    <div id="modos">
        <div class="glitch">ELIGE MODO</div>
        <button class="play-btn mode-day" onclick="startGame('dia')">DÍA (Fácil)</button>
        <button class="play-btn mode-sunset" onclick="startGame('tarde')">TARDE (Normal)</button>
        <button class="play-btn mode-night" onclick="startGame('noche')">NOCHE (Difícil)</button>
    </div>

    <div id="death">
        <h1 style="color:red">TE ATRAPÓ</h1>
        <button class="play-btn" onclick="location.reload()">REINTENTAR</button>
    </div>

    <div id="win">
        <h1 id="win-title" style="color:#0f0">¡GANASTE!</h1>
        <p id="win-desc"></p>
        <button class="play-btn" onclick="location.reload()">VOLVER</button>
    </div>

    <div id="joy-move" class="joystick-base"><div id="move-knob" class="knob"></div></div>
    <div id="joy-look" class="joystick-base"><div id="look-knob" class="knob"></div></div>

    <script src="https://unpkg.com/three@0.150.1/build/three.min.js"></script>
    <script>
        let scene, camera, renderer, player, tinky, papillas = [], score = 0, gameActive = false;
        let moveInput = {x:0, y:0}, lookInput = {x:0, y:0};
        let isThirdPerson = false, currentModo = 'dia';
        let fallingTrees = [];
        let screamPlayed = false;
        let audioCtx;

        let vy = 0, isGrounded = true;
        const GRAVITY = -0.012, JUMP_FORCE = 0.28, SENS = 0.02;

        function showModes() {
            document.getElementById('menu').style.display = 'none';
            document.getElementById('modos').style.display = 'flex';
        }

        function initScene(modo) {
            currentModo = modo;
            scene = new THREE.Scene();
            let fogCol, skyCol;

            if(modo === 'dia') {
                skyCol = 0x87CEEB; fogCol = 0x87CEEB;
                scene.add(new THREE.HemisphereLight(0xffffff, 0x444444, 1.3));
            } else if(modo === 'tarde') {
                skyCol = 0xffa07a; fogCol = 0xffa07a;
                scene.add(new THREE.HemisphereLight(0xffa07a, 0x222244, 1.0));
            } else {
                skyCol = 0x010103; fogCol = 0x010103;
                scene.add(new THREE.HemisphereLight(0x4444ff, 0x000000, 0.2));
            }

            scene.background = new THREE.Color(skyCol);
            scene.fog = new THREE.Fog(fogCol, 1, 55);

            camera = new THREE.PerspectiveCamera(90, window.innerWidth/window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            player = new THREE.Group();
            player.position.set(0, 0, 40);
            scene.add(player);
            
            const body = new THREE.Mesh(new THREE.CapsuleGeometry(0.4, 1), new THREE.MeshStandardMaterial({color: 0xeeeeee}));
            body.position.y = 0.9;
            player.add(body);
            player.add(camera);
            updateCameraPos();

            const ground = new THREE.Mesh(new THREE.PlaneGeometry(300, 300), new THREE.MeshStandardMaterial({color: 0x112211}));
            ground.rotation.x = -Math.PI/2; scene.add(ground);

            // Personajes Secundarios
            const laalaa = new THREE.Mesh(new THREE.CapsuleGeometry(0.4, 1.2), new THREE.MeshStandardMaterial({color: "yellow"}));
            laalaa.position.set(25, 0.6, 15); scene.add(laalaa);

            const po = new THREE.Mesh(new THREE.CapsuleGeometry(0.35, 1.1), new THREE.MeshStandardMaterial({color: "red"}));
            po.position.set(-20, 4, 10); po.rotation.z = 0.2; scene.add(po);

            // Árboles Trampa
            for(let i=0; i<2; i++){
                const tGroup = new THREE.Group();
                const trunk = new THREE.Mesh(new THREE.CylinderGeometry(0.3, 0.4, 8), new THREE.MeshStandardMaterial({color: 0x3d2817}));
                trunk.position.y = 4; tGroup.add(trunk);
                tGroup.position.set(i==0 ? 8 : -8, 0, 25);
                scene.add(tGroup);
                fallingTrees.push({obj: tGroup, fell: false});
            }

            // Bosque
            for(let i=0; i<90; i++) {
                const t = new THREE.Mesh(new THREE.CylinderGeometry(0.2, 0.4, 6), new THREE.MeshStandardMaterial({color: 0x221100}));
                t.position.set(Math.random()*180-90, 3, Math.random()*180-90);
                scene.add(t);
            }

            for(let i=0; i<10; i++) {
                const p = new THREE.Mesh(new THREE.SphereGeometry(0.35), new THREE.MeshStandardMaterial({color: 0xff00ff, emissive: 0xff00ff, emissiveIntensity: 0.5}));
                p.position.set(Math.random()*150-75, 0.35, Math.random()*150-75);
                scene.add(p); papillas.push(p);
            }

            tinky = new THREE.Mesh(new THREE.CapsuleGeometry(0.6, 1.8), new THREE.MeshStandardMaterial({color: 0x2a0050}));
            tinky.position.set(0, 0.9, -30);
            scene.add(tinky);

            setupControls();
        }

        function playScream() {
            if(screamPlayed) return;
            screamPlayed = true;
            if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            let osc = audioCtx.createOscillator();
            let gain = audioCtx.createGain();
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(120, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(30, audioCtx.currentTime + 1.2);
            gain.gain.setValueAtTime(0.15, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 1.2);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + 1.2);
        }

        function jump() { if(isGrounded) { vy = JUMP_FORCE; isGrounded = false; } }
        function toggleCamera() { isThirdPerson = !isThirdPerson; updateCameraPos(); }
        function updateCameraPos() {
            if(isThirdPerson) camera.position.set(0, 3, 6);
            else camera.position.set(0, 1.7, 0.2);
        }

        function setupControls() {
            const joys = [{base: document.getElementById('joy-move'), knob: document.getElementById('move-knob'), isMove: true}, {base: document.getElementById('joy-look'), knob: document.getElementById('look-knob'), isMove: false}];
            joys.forEach(j => {
                j.base.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                    const t = e.targetTouches[0];
                    const r = j.base.getBoundingClientRect();
                    const dx = t.clientX - (r.left + 55), dy = t.clientY - (r.top + 55);
                    const d = Math.min(Math.sqrt(dx*dx + dy*dy), 45);
                    const kx = (dx/45)*d, ky = (dy/45)*d;
                    j.knob.style.transform = `translate(${kx}px,${ky}px)`;
                    if(j.isMove) moveInput = {x:kx/45, y:ky/45}; else lookInput = {x:kx/45, y:ky/45};
                });
                j.base.addEventListener('touchend', () => { j.knob.style.transform = ''; if(j.isMove) moveInput={x:0,y:0}; else lookInput={x:0,y:0}; });
            });
        }

        function startGame(modo) {
            document.getElementById('modos').style.display = 'none';
            initScene(modo);
            gameActive = true;
            animate();
        }

        function checkWin() {
            gameActive = false;
            const title = document.getElementById('win-title');
            const desc = document.getElementById('win-desc');
            document.getElementById('win').style.display = 'flex';
            
            if(currentModo === 'dia') {
                title.innerText = "SISTEMA LIMPIO";
                desc.innerText = "Has purificado el bosque bajo la luz del sol.";
            } else if(currentModo === 'tarde') {
                title.innerText = "ATARDECER SEGURO";
                desc.innerText = "Lograste escapar antes de que la oscuridad total te alcanzara.";
            } else {
                title.innerText = "SOBREVIVISTE A LA PESADILLA";
                desc.innerText = "Eres una leyenda. Has vencido a Tinky en su terreno más oscuro.";
            }
        }

        function animate() {
            if(!gameActive) return;
            requestAnimationFrame(animate);

            // Velocidad reducida para mayor tensión
            const fwd = new THREE.Vector3(0,0,-1).applyQuaternion(player.quaternion);
            const side = new THREE.Vector3(1,0,0).applyQuaternion(player.quaternion);
            player.position.addScaledVector(fwd, -moveInput.y*0.13);
            player.position.addScaledVector(side, moveInput.x*0.13);

            vy += GRAVITY;
            player.position.y += vy;
            if(player.position.y <= 0) { player.position.y = 0; vy = 0; isGrounded = true; }

            player.rotation.y -= lookInput.x * SENS;
            camera.rotation.x -= lookInput.y * SENS;
            camera.rotation.x = Math.max(-1.2, Math.min(1.2, camera.rotation.x));

            fallingTrees.forEach(t => {
                if(t.obj.position.distanceTo(player.position) < 7) t.fell = true;
                if(t.fell && t.obj.rotation.x < 1.4) t.obj.rotation.x += 0.04;
            });

            tinky.lookAt(player.position.x, 0.9, player.position.z);
            tinky.translateZ(currentModo === 'noche' ? 0.08 : 0.06);

            const d = tinky.position.distanceTo(player.position);
            document.getElementById('estatica').style.opacity = d < 12 ? (12 - d) / 12 : 0;
            
            if(d < 6) playScream();
            else if(d > 9) screamPlayed = false;

            papillas.forEach((p, i) => {
                if(p.position.distanceTo(player.position) < 1.8) {
                    scene.remove(p); papillas.splice(i, 1);
                    score++; document.getElementById('contador').innerText = `PAPILLAS: ${score} / 10`;
                    if(score === 10) checkWin();
                }
            });

            if(d < 1.5) { gameActive = false; document.getElementById('death').style.display = 'flex'; }
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>

