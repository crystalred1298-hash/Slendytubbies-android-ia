<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Slendytubbies: Forbidden Woods</title>
    
    <style>
        :root { --accent: #ff00ff; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; overflow: hidden; background: #000; touch-action: none; font-family: 'Courier New', Courier, monospace; width: 100vw; height: 100vh; }

        /* HUD */
        #ui-container { position: absolute; top: 20px; width: 100%; display: flex; justify-content: space-between; padding: 0 25px; z-index: 500; pointer-events: none; }
        #contador { background: rgba(20, 0, 20, 0.9); color: var(--accent); padding: 10px 20px; border: 2px solid var(--accent); font-weight: bold; pointer-events: auto; }
        #msg-pick { position: absolute; bottom: 20%; width: 100%; text-align: center; color: white; font-size: 1.2rem; display: none; text-shadow: 2px 2px #000; z-index: 550; }

        /* Jumpscare */
        #jumpscare-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2000; display: none; background: url('https://i.imgur.com/vS386rL.png') center/cover; }

        #jump-btn { position: absolute; right: 40px; bottom: 220px; width: 80px; height: 80px; background: rgba(255, 255, 255, 0.1); border: 2px solid var(--accent); border-radius: 50%; color: white; z-index: 600; display: flex; align-items: center; justify-content: center; }
        #estatica { position: absolute; width: 100%; height: 100%; top: 0; left: 0; background: url('https://media.giphy.com/media/oEI9uWUic8vle/giphy.gif'); opacity: 0; pointer-events: none; z-index: 400; mix-blend-mode: screen; }

        .joystick-base { position: absolute; width: 120px; height: 120px; background: rgba(255,255,255,0.05); border: 1px solid var(--accent); border-radius: 50%; z-index: 100; bottom: 70px; }
        #joy-move { left: 40px; }
        #joy-look { right: 40px; }
        .knob { position: absolute; width: 50px; height: 50px; background: var(--accent); border-radius: 50%; top: 35px; left: 35px; }

        .overlay-screen { position: absolute; width: 100%; height: 100%; z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #000; color: var(--accent); text-align: center; border: 10px solid #1a001a; }
        .play-btn { padding: 15px 40px; background: transparent; color: var(--accent); border: 2px solid var(--accent); cursor: pointer; font-weight: bold; margin: 10px; }
        .play-btn:hover { background: var(--accent); color: #000; }
    </style>
</head>
<body>

    <div id="jumpscare-overlay"></div>
    <div id="estatica"></div>
    <div id="ui-container">
        <div id="contador">SISTEMA: BUSCANDO PAPILLAS [0/10]</div>
    </div>
    <div id="msg-pick">MESA DETECTADA: ACÉRCATE PARA TOMAR LINTERNA</div>

    <div id="jump-btn" onpointerdown="jump()">SALTO</div>

    <div id="menu" class="overlay-screen">
        <h1 style="font-size: 3rem;">V_LOG: 001</h1>
        <p>BOSQUE DE LAS ALMAS PERDIDAS</p>
        <button class="play-btn" onclick="showModes()">ACCEDER</button>
    </div>

    <div id="modos" class="overlay-screen" style="display: none;">
        <h2>MODO DE VISIÓN</h2>
        <button class="play-btn" onclick="startGame('dia')">DIURNO</button>
        <button class="play-btn" onclick="startGame('tarde')">CREPÚSCULO</button>
        <button class="play-btn" onclick="startGame('noche')">NOCTURNO</button>
    </div>

    <div id="death" class="overlay-screen" style="display:none"><h1>CONEXIÓN PERDIDA</h1><button class="play-btn" onclick="location.reload()">RECONECTAR</button></div>

    <div id="joy-move" class="joystick-base"><div id="move-knob" class="knob"></div></div>
    <div id="joy-look" class="joystick-base"><div id="look-knob" class="knob"></div></div>

    <script src="https://unpkg.com/three@0.150.1/build/three.min.js"></script>
    <script>
        let scene, camera, renderer, player, tinky, noonoo, laalaa, po, papillas = [], score = 0, gameActive = false;
        let moveInput = {x:0, y:0}, lookInput = {x:0, y:0};
        let handGroup, hasFlashlight = false, flashlightObj;
        let vy = 0, isGrounded = true;
        let laalaaState = 'sitting', poState = 'hanging';
        let audioCtx;
        const GRAVITY = -0.012, JUMP_FORCE = 0.28;

        function showModes() { document.getElementById('menu').style.display = 'none'; document.getElementById('modos').style.display = 'flex'; }

        function initScene(modo) {
            scene = new THREE.Scene();
            let fogCol = (modo==='dia') ? 0x87CEEB : (modo==='tarde' ? 0xcc6633 : 0x000000);
            scene.background = new THREE.Color(fogCol);
            scene.fog = new THREE.Fog(fogCol, 1, 60);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            player = new THREE.Group();
            player.position.set(0, 0, 10); // Empezamos cerca de la mesa
            scene.add(player);
            player.add(camera);

            // MANO (INICIALMENTE OCULTA)
            handGroup = new THREE.Group();
            const arm = new THREE.Mesh(new THREE.CylinderGeometry(0.04, 0.05, 0.5), new THREE.MeshStandardMaterial({color: 0xffdbac}));
            arm.rotation.x = Math.PI/1.8; arm.position.set(0.35, -0.25, -0.3);
            const lamp = new THREE.Mesh(new THREE.CylinderGeometry(0.05, 0.03, 0.25), new THREE.MeshStandardMaterial({color: 0x111111}));
            lamp.rotation.x = Math.PI/2; lamp.position.set(0.35, -0.15, -0.5);
            const light = new THREE.SpotLight(0xffffff, 3, 35, Math.PI/6, 0.5);
            light.position.set(0.35, -0.15, -0.5);
            light.target.position.set(0.35, -0.15, -10);
            handGroup.add(arm, lamp, light, light.target);
            camera.add(handGroup);
            handGroup.visible = false;

            // MESA DE INICIO
            const table = new THREE.Group();
            const top = new THREE.Mesh(new THREE.BoxGeometry(2, 0.1, 1), new THREE.MeshStandardMaterial({color: 0x4d2600}));
            top.position.y = 0.8;
            const leg = new THREE.Mesh(new THREE.BoxGeometry(0.1, 0.8, 0.1), new THREE.MeshStandardMaterial({color: 0x4d2600}));
            leg.position.set(0.8, 0.4, 0.4);
            table.add(top, leg);
            table.position.set(0, 0, 5);
            scene.add(table);

            // LINTERNA EN LA MESA
            flashlightObj = new THREE.Mesh(new THREE.CylinderGeometry(0.05, 0.03, 0.3), new THREE.MeshStandardMaterial({color: 0x111111}));
            flashlightObj.position.set(0, 0.9, 5);
            flashlightObj.rotation.z = Math.PI/2;
            scene.add(flashlightObj);

            // MUNDO
            scene.add(new THREE.AmbientLight(0xffffff, modo==='dia'?0.5:0.05));
            const ground = new THREE.Mesh(new THREE.PlaneGeometry(300, 300), new THREE.MeshStandardMaterial({color: 0x050a05}));
            ground.rotation.x = -Math.PI/2; scene.add(ground);

            // PERSONAJES
            tinky = new THREE.Mesh(new THREE.CapsuleGeometry(0.6, 1.8), new THREE.MeshStandardMaterial({color: 0x2a0050}));
            tinky.position.set(0, 0.9, -50); scene.add(tinky);

            laalaa = new THREE.Mesh(new THREE.CapsuleGeometry(0.4, 1.2), new THREE.MeshStandardMaterial({color: "yellow"}));
            laalaa.position.set(40, 0.6, 20); scene.add(laalaa);

            po = new THREE.Mesh(new THREE.CapsuleGeometry(0.35, 1.1), new THREE.MeshStandardMaterial({color: "red"}));
            po.position.set(-20, 8, -10); scene.add(po);

            for(let i=0; i<8; i++) {
                const p = new THREE.Mesh(new THREE.SphereGeometry(0.3), new THREE.MeshStandardMaterial({color: 0xff00ff, emissive: 0xff00ff}));
                p.position.set(Math.random()*160-80, 0.3, Math.random()*160-80);
                scene.add(p); papillas.push(p);
            }

            setupControls();
            camera.position.y = 1.7;
        }

        function jump() { if(isGrounded) { vy = JUMP_FORCE; isGrounded = false; } }

        function setupControls() {
            const joys = [{id:'joy-move', knob:'move-knob', isMove:true}, {id:'joy-look', knob:'look-knob', isMove:false}];
            joys.forEach(j => {
                const base = document.getElementById(j.id);
                const knob = document.getElementById(j.knob);
                base.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                    const t = e.targetTouches[0];
                    const r = base.getBoundingClientRect();
                    const dx = t.clientX - (r.left + 60), dy = t.clientY - (r.top + 60);
                    const d = Math.min(Math.sqrt(dx*dx + dy*dy), 50);
                    knob.style.transform = `translate(${(dx/50)*d}px,${(dy/50)*d}px)`;
                    if(j.isMove) moveInput = {x:dx/50, y:dy/50}; else lookInput = {x:dx/50, y:dy/50};
                });
                base.addEventListener('touchend', () => { knob.style.transform = ''; if(j.isMove) moveInput={x:0,y:0}; else lookInput={x:0,y:0}; });
            });
        }

        function triggerJumpscare() {
            const overlay = document.getElementById('jumpscare-overlay');
            overlay.style.display = 'block';
            if(!audioCtx) audioCtx = new AudioContext();
            let osc = audioCtx.createOscillator();
            let g = audioCtx.createGain();
            osc.type = 'sawtooth'; osc.frequency.value = 60;
            g.gain.value = 0.2; osc.connect(g); g.connect(audioCtx.destination);
            osc.start();
            setTimeout(() => { overlay.style.display = 'none'; osc.stop(); }, 600);
        }

        function startGame(modo) { document.getElementById('modos').style.display = 'none'; initScene(modo); gameActive = true; animate(); }

        function animate() {
            if(!gameActive) return;
            requestAnimationFrame(animate);

            // Barreras Invisibles (Límites 100x100)
            const nextX = player.position.x + (-moveInput.y * Math.sin(player.rotation.y) + moveInput.x * Math.cos(player.rotation.y)) * 0.13;
            const nextZ = player.position.z + (-moveInput.y * Math.cos(player.rotation.y) - moveInput.x * Math.sin(player.rotation.y)) * 0.13;
            
            if(Math.abs(nextX) < 95) player.position.x = nextX;
            if(Math.abs(nextZ) < 95) player.position.z = nextZ;

            vy += GRAVITY; player.position.y += vy;
            if(player.position.y <= 0) { player.position.y = 0; vy = 0; isGrounded = true; }

            player.rotation.y -= lookInput.x * 0.02;
            camera.rotation.x -= lookInput.y * 0.02;

            // Recoger Linterna
            if(!hasFlashlight) {
                const distTable = player.position.distanceTo(new THREE.Vector3(0,0,5));
                document.getElementById('msg-pick').style.display = distTable < 3 ? 'block' : 'none';
                if(distTable < 1.5) {
                    hasFlashlight = true;
                    scene.remove(flashlightObj);
                    handGroup.visible = true;
                    document.getElementById('msg-pick').innerText = "LINTERNA OBTENIDA";
                    setTimeout(()=>document.getElementById('msg-pick').style.display='none', 2000);
                }
            }

            // Jumpscares aleatorios
            if(Math.random() < 0.0005) triggerJumpscare();

            // LAA LAA Y PO
            if(laalaa.position.distanceTo(player.position) < 7) laalaa.position.y = Math.min(laalaa.position.y + 0.1, 1.2);
            if(new THREE.Vector2(po.position.x, po.position.z).distanceTo(new THREE.Vector2(player.position.x, player.position.z)) < 5) po.position.y = Math.max(po.position.y - 0.4, 0.6);

            // TINKY IA
            tinky.lookAt(player.position.x, 0.9, player.position.z);
            tinky.translateZ(0.07);

            const d = tinky.position.distanceTo(player.position);
            document.getElementById('estatica').style.opacity = d < 12 ? (12-d)/12 : 0;
            if(d < 1.6) { gameActive = false; document.getElementById('death').style.display='flex'; }

            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
