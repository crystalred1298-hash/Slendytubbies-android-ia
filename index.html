<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Slendytubbies: Chainsaw Update</title>
    
    <style>
        :root { --accent: #ff00ff; --danger: #ff0000; --win: #00ff00; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Courier New', Courier, monospace; width: 100vw; height: 100vh; }

        /* HUD */
        #ui-container { position: absolute; top: 20px; width: 100%; display: flex; justify-content: center; z-index: 500; pointer-events: none; }
        #contador { background: rgba(0, 0, 0, 0.8); color: var(--accent); padding: 10px 20px; border: 1px solid var(--accent); font-weight: bold; border-radius: 5px; }
        #msg-pick { position: absolute; bottom: 30%; width: 100%; text-align: center; color: white; font-size: 1.2rem; display: none; text-shadow: 0 0 10px #ff0000; z-index: 550; animation: blink 0.5s infinite; }

        @keyframes blink { 50% { opacity: 0; } }

        /* Controles */
        .joystick-base { position: absolute; width: 110px; height: 110px; background: rgba(255,255,255,0.1); border: 2px solid var(--accent); border-radius: 50%; z-index: 100; bottom: 40px; touch-action: none; }
        #joy-move { left: 25px; }
        #joy-look { right: 25px; }
        .knob { position: absolute; width: 45px; height: 45px; background: var(--accent); border-radius: 50%; top: 30px; left: 30px; box-shadow: 0 0 15px var(--accent); }
        
        #jump-btn { position: absolute; right: 35px; bottom: 170px; width: 65px; height: 65px; background: rgba(255, 0, 255, 0.2); border: 2px solid var(--accent); border-radius: 50%; color: white; z-index: 600; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.8rem; box-shadow: 0 0 10px var(--accent); }

        /* Pantallas */
        .overlay-screen { position: absolute; width: 100%; height: 100%; z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; background: radial-gradient(circle, #220022 0%, #000 100%); color: var(--accent); text-align: center; }
        .play-btn { padding: 12px 30px; background: transparent; color: var(--accent); border: 1px solid var(--accent); cursor: pointer; font-weight: bold; margin: 8px; width: 260px; text-transform: uppercase; letter-spacing: 2px; }
        .play-btn:hover { background: var(--accent); color: #000; }

        #estatica { position: absolute; width: 100%; height: 100%; top: 0; left: 0; background: url('https://media.giphy.com/media/oEI9uWUic8vle/giphy.gif'); opacity: 0; pointer-events: none; z-index: 400; mix-blend-mode: screen; }
    </style>
</head>
<body>

    <div id="estatica"></div>
    <div id="ui-container"><div id="contador">SISTEMA: [PAPILLAS 0/10]</div></div>
    <div id="msg-pick">¡FASE DE PÁNICO ACTIVADA!</div>
    <div id="jump-btn">JUMP</div>

    <div id="menu-inicio" class="overlay-screen">
        <h1 style="font-size: 2rem; text-shadow: 0 0 20px var(--accent);">ST: DATABASE ACCESS</h1>
        <button class="play-btn" onclick="showScreen('menu-inicio', 'menu-mapas')">CONECTAR ARCHIVOS</button>
    </div>

    <div id="menu-mapas" class="overlay-screen" style="display:none">
        <h2>UBICACIÓN</h2>
        <button class="play-btn" onclick="selectMap('teletubbielandia')">TELETUBBIELANDIA</button>
        <button class="play-btn" onclick="selectMap('fabrica')">LA FÁBRICA</button>
        <button class="play-btn" onclick="selectMap('cuevas')">LAS CUEVAS</button>
    </div>

    <div id="menu-horas" class="overlay-screen" style="display:none">
        <h2>FILTRO VISUAL</h2>
        <button class="play-btn" onclick="startGame('dia')">DÍA</button>
        <button class="play-btn" onclick="startGame('noche')">NOCHE</button>
    </div>

    <div id="death" class="overlay-screen" style="display:none"><h1 style="color:red; font-size: 3rem;">CONEXIÓN PERDIDA</h1><button class="play-btn" onclick="location.reload()">REINTENTAR</button></div>
    <div id="win" class="overlay-screen" style="display:none"><h1 style="color:lime">ZONA SEGURA ALCANZADA</h1><button class="play-btn" onclick="location.reload()">INICIO</button></div>

    <div id="joy-move" class="joystick-base"><div id="move-knob" class="knob"></div></div>
    <div id="joy-look" class="joystick-base"><div id="look-knob" class="knob"></div></div>

    <script src="https://unpkg.com/three@0.150.1/build/three.min.js"></script>
    <script>
        let scene, camera, renderer, player, enemies = [], papillas = [], rocaBase;
        let score = 0, gameActive = false, selectedMap = '', panicMode = false;
        let moveInput = {x:0, y:0}, lookInput = {x:0, y:0}, vy = 0, isGrounded = true;
        let chainsawMesh;
        
        const GRAVITY = -0.012, JUMP_FORCE = 0.28;

        function showScreen(hide, show) {
            document.getElementById(hide).style.display = 'none';
            document.getElementById(show).style.display = 'flex';
        }

        function selectMap(map) {
            selectedMap = map;
            showScreen('menu-mapas', 'menu-horas');
        }

        function initScene(modo) {
            scene = new THREE.Scene();
            let fogCol = (modo === 'dia') ? 0x87CEEB : 0x000000;
            if(selectedMap === 'cuevas') fogCol = 0x111111;
            scene.background = new THREE.Color(fogCol);
            scene.fog = new THREE.Fog(fogCol, 1, 65);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            player = new THREE.Group();
            player.position.set(0, 0, 15);
            scene.add(player);
            player.add(camera);

            // MAPAS LOGIC
            let groundCol = 0x228B22; // Verde por defecto
            if(selectedMap === 'fabrica') groundCol = 0x333333;
            if(selectedMap === 'cuevas') groundCol = 0x1a1a1a;

            const ground = new THREE.Mesh(new THREE.PlaneGeometry(300, 300), new THREE.MeshStandardMaterial({color: groundCol}));
            ground.rotation.x = -Math.PI/2;
            scene.add(ground);

            if(selectedMap === 'teletubbielandia') {
                const dome = new THREE.Mesh(new THREE.SphereGeometry(12, 32, 20, 0, Math.PI*2, 0, Math.PI/2), new THREE.MeshStandardMaterial({color: 0x1e3d1e}));
                dome.position.set(-30, 0, -30);
                scene.add(dome);
                for(let i=0; i<40; i++) {
                    const tree = new THREE.Mesh(new THREE.CylinderGeometry(0.2, 0.5, 6), new THREE.MeshStandardMaterial({color: 0x221100}));
                    tree.position.set(Math.random()*160-80, 3, Math.random()*160-80);
                    scene.add(tree);
                }
            } else if(selectedMap === 'fabrica') {
                for(let i=0; i<20; i++) createWall(Math.random()*100-50, Math.random()*100-50, 8, 10);
            } else {
                for(let i=0; i<40; i++) createRock(Math.random()*120-60, Math.random()*120-60);
            }

            // ROCA DE VICTORIA
            rocaBase = new THREE.Mesh(new THREE.OctahedronGeometry(3), new THREE.MeshStandardMaterial({color: 0x222, emissive: 0xff00ff}));
            rocaBase.position.set(85, 0, -85);
            scene.add(rocaBase);

            // ENEMIGOS
            enemies.push(createEnemy(0x2a0050, "Tinky", 0, -50));
            enemies.push(createEnemy(0x005500, "Dipsy", 40, -40));
            enemies.push(createEnemy(0xaaaa00, "Laalaa", -40, 20));
            enemies.push(createEnemy(0x770000, "Po", 50, 50));

            // MOTOSIERRA PARA DIPSY
            if(selectedMap === 'fabrica') {
                chainsawMesh = new THREE.Mesh(new THREE.BoxGeometry(0.3, 0.4, 1.5), new THREE.MeshStandardMaterial({color: 0x111}));
                chainsawMesh.position.set(0.6, 0, 0.8);
                enemies[1].add(chainsawMesh); // El 1 es Dipsy
            }

            // PAPILLAS
            for(let i=0; i<10; i++) {
                const p = new THREE.Mesh(new THREE.SphereGeometry(0.4), new THREE.MeshStandardMaterial({color:0xff00ff, emissive:0xff00ff, emissiveIntensity: 2}));
                p.position.set(Math.random()*150-75, 0.4, Math.random()*150-75);
                scene.add(p); papillas.push(p);
            }

            scene.add(new THREE.AmbientLight(0xffffff, modo==='dia'? 0.5 : 0.05));
            const flashlight = new THREE.SpotLight(0xffffff, 4, 35, 0.4);
            camera.add(flashlight);
            camera.add(flashlight.target);
            flashlight.target.position.z = -10;

            setupControls();
            camera.position.y = 1.7;
        }

        function createWall(x, z, w, h) {
            const wall = new THREE.Mesh(new THREE.BoxGeometry(w, h, 2), new THREE.MeshStandardMaterial({color: 0x111, metalness: 0.8}));
            wall.position.set(x, h/2, z);
            scene.add(wall);
        }

        function createRock(x, z) {
            const rock = new THREE.Mesh(new THREE.DodecahedronGeometry(2 + Math.random()*3), new THREE.MeshStandardMaterial({color: 0x222}));
            rock.position.set(x, 0, z);
            scene.add(rock);
        }

        function createEnemy(col, name, x, z) {
            const e = new THREE.Mesh(new THREE.CapsuleGeometry(0.6, 1.4), new THREE.MeshStandardMaterial({color: col}));
            e.position.set(x, 1, z);
            e.userData = { speed: 0.07, name: name };
            scene.add(e);
            return e;
        }

        function setupControls() {
            const joys = [{id:'joy-move', knob:'move-knob', isMove:true}, {id:'joy-look', knob:'look-knob', isMove:false}];
            joys.forEach(j => {
                const base = document.getElementById(j.id);
                const knob = document.getElementById(j.knob);
                base.addEventListener('touchmove', (e) => {
                    const t = e.targetTouches[0];
                    const r = base.getBoundingClientRect();
                    const dx = t.clientX - (r.left + 55), dy = t.clientY - (r.top + 55);
                    const d = Math.min(Math.sqrt(dx*dx + dy*dy), 45);
                    knob.style.transform = `translate(${(dx/45)*d}px,${(dy/45)*d}px)`;
                    if(j.isMove) moveInput = {x:dx/45, y:dy/45}; else lookInput = {x:dx/45, y:dy/45};
                });
                base.addEventListener('touchend', () => { knob.style.transform = ''; if(j.isMove) moveInput={x:0,y:0}; else lookInput={x:0,y:0}; });
            });
            document.getElementById('jump-btn').addEventListener('touchstart', (e) => {
                e.preventDefault();
                if(isGrounded) { vy = JUMP_FORCE; isGrounded = false; }
            });
        }

        function startGame(hora) {
            document.getElementById('menu-horas').style.display = 'none';
            initScene(hora);
            gameActive = true;
            animate();
        }

        function animate() {
            if(!gameActive) return;
            requestAnimationFrame(animate);

            // PLAYER PHYSICS
            const forward = new THREE.Vector3(0,0,-1).applyQuaternion(player.quaternion);
            const side = new THREE.Vector3(1,0,0).applyQuaternion(player.quaternion);
            player.position.addScaledVector(forward, -moveInput.y * 0.18);
            player.position.addScaledVector(side, moveInput.x * 0.18);

            vy += GRAVITY;
            player.position.y += vy;
            if(player.position.y <= 0) { player.position.y = 0; vy = 0; isGrounded = true; }

            player.rotation.y -= lookInput.x * 0.05;
            camera.rotation.x = Math.max(-1.4, Math.min(1.4, camera.rotation.x - lookInput.y * 0.05));

            // PAPILLAS
            papillas.forEach((p, i) => {
                if(p.position.distanceTo(player.position) < 1.8) {
                    scene.remove(p); papillas.splice(i, 1);
                    score++;
                    document.getElementById('contador').innerText = `SISTEMA: [PAPILLAS ${score}/10]`;
                    if(score === 10) triggerPanic();
                }
            });

            // ENEMIES AI
            enemies.forEach(e => {
                let dist = e.position.distanceTo(player.position);
                if(panicMode || e.userData.name === "Tinky") {
                    e.lookAt(player.position.x, 1, player.position.z);
                    e.translateZ(e.userData.speed);
                    if(e.userData.name === "Dipsy" && chainsawMesh) {
                        chainsawMesh.rotation.z += 0.5; // Efecto de rotación de motosierra
                    }
                }
                if(dist < 2) { gameActive = false; document.getElementById('death').style.display='flex'; }
                if(e.userData.name === "Tinky") document.getElementById('estatica').style.opacity = dist < 15 ? (15-dist)/15 : 0;
            });

            // ESCAPE
            if(score >= 10 && player.position.distanceTo(rocaBase.position) < 6) {
                gameActive = false; document.getElementById('win').style.display='flex';
            }

            renderer.render(scene, camera);
        }

        function triggerPanic() {
            panicMode = true;
            scene.fog.color.set(0x550000);
            scene.background.set(0x220000);
            document.getElementById('msg-pick').style.display = 'block';
            enemies.forEach(e => e.userData.speed = 0.14);
        }
    </script>
</body>
</html>
